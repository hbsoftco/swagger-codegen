#language: java
#jdk:
#- oraclejdk8
# no need to test jdk7 as smoke test is already covered by travis-ci
#- openjdk7
language: node_js
node_js:
  - 6.7.0

addons:
  hosts:
    - petstore.swagger.io

build:
  cache: true
  cache_dir_list:
    - $HOME/.m2
    - $SHIPPABLE_BUILD_DIR/node_modules
  pre_ci:
    # use node 4
    #- nvm install 4.0
    # install typescript
    - npm install -g typescript
    # start petstore
    - docker ps -a
    #- docker stop `docker ps -q -f "name=swaggerapi/petstore"` || 1
    - if docker ps -a | grep "swaggerapi/petstore"; then docker stop $(docker ps -q --filter ancestor="swaggerapi/petstore" ); fi
    - docker ps -a
    - docker pull swaggerapi/petstore
    - docker run -d -e SWAGGER_HOST=http://petstore.swagger.io -e SWAGGER_BASE_PATH=/v2 -p 80:8080 swaggerapi/petstore
    - docker ps -a
  ci:
    ### test JS/TS clients
    # test TS jquery
    - cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/typescript-jquery/npm/" && npm install
    # test TS fetch
    - cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/typescript-fetch/builds/default" && npm install
    - cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/typescript-fetch/builds/es6-target" && npm install
    - cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/typescript-fetch/builds/with-npm-version" && npm install
    - cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/typescript-fetch/tests/default" && npm install &&  npm test
    # test TS angualr
    - cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/typescript-angular" && npm install
    # test TS node
    - cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/typescript-node/npm" && npm install && npm test
    # test JS client
    #- cd "${SHIPPABLE_BUILD_DIR}/samples/client/petstore/javascript/" && npm install && npm test
    # test NodeJS server
    - cd "${SHIPPABLE_BUILD_DIR}/samples/server/petstore/nodejs/" && npm install
    # generate all petstore sampless (client, servers, doc)
    - cd $SHIPPABLE_BUILD_DIR && ./bin/run-all-petstore 2>&1 > run-all-petstore.log
  post_ci:
    - tail run-all-petstore.log
    - docker stop `docker ps -q -f "name=swaggerapi/petstore"`
